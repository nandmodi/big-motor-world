<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKU Selection Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        .image-container {
            transition: transform 0.2s;
        }
        .image-container:hover {
            transform: translateY(-4px);
        }
        .checkbox-overlay {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #2563eb;
            z-index: 20;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-gray-600 font-medium">Fetching Source Data...</p>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-100">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Login</h1>
                <p class="text-gray-500">Select your name and category to continue</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">User Name</label>
                    <select id="user-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="Rajmani">Rajmani</option>
                        <option value="Mohit">Mohit</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                    <select id="category-list" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">Loading categories...</option>
                    </select>
                </div>

                <button onclick="handleLogin()" id="login-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all shadow-lg active:scale-95">
                    Enter Portal
                </button>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="main-page" class="hidden h-screen flex flex-col">
        <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-10">
            <div>
                <h2 class="text-lg font-bold text-gray-800" id="header-user">Welcome</h2>
                <p class="text-xs text-blue-600 font-semibold uppercase tracking-wider" id="header-cat"></p>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <span id="selection-count" class="text-sm font-medium text-gray-600">0 Items Selected</span>
                </div>
                <button onclick="submitToForm()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-full font-bold transition shadow-md flex items-center gap-2">
                    Submit Selection
                </button>
            </div>
        </header>

        <main class="flex-1 flex overflow-hidden">
            <!-- Left Side: NEW -->
            <section class="w-1/2 flex flex-col border-r border-gray-200 bg-white">
                <div class="bg-blue-50 p-3 border-b border-blue-100 flex justify-between items-center">
                    <h3 class="font-bold text-blue-800 uppercase text-sm tracking-widest">NEW MODELS</h3>
                    <span class="bg-blue-200 text-blue-800 text-[10px] px-2 py-0.5 rounded-full font-bold">LEFT SIDE</span>
                </div>
                <div id="new-grid" class="flex-1 overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 content-start">
                    <!-- Cards injected here -->
                </div>
            </section>

            <!-- Right Side: PROD -->
            <section class="w-1/2 flex flex-col bg-gray-50">
                <div class="bg-emerald-50 p-3 border-b border-emerald-100 flex justify-between items-center">
                    <h3 class="font-bold text-emerald-800 uppercase text-sm tracking-widest">PROD MODELS</h3>
                    <span class="bg-emerald-200 text-emerald-800 text-[10px] px-2 py-0.5 rounded-full font-bold">RIGHT SIDE</span>
                </div>
                <div id="prod-grid" class="flex-1 overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 content-start">
                    <!-- Cards injected here -->
                </div>
            </section>
        </main>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRGCcDlcoYzbElD-e7ZOuwqQm-vfTOUff10tO9jgb4kZXng7CaWTev0-k2srzI4NBvsFhk2FytkHpb/pub?gid=0&single=true&output=csv';
        const FORM_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSeraoBf6s2nHnlflVGtzMWpHv2j1wpF4p3FfgQ-t_8yneOdjg/viewform?usp=pp_url";

        let fullDataset = [];
        let currentUser = "";
        let currentCategory = "";

        // Initialize App
        window.addEventListener('DOMContentLoaded', () => {
            fetchCSV();
        });

        async function fetchCSV() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                complete: (results) => {
                    fullDataset = results.data.filter(row => row.Sku_id);
                    populateCategories();
                    document.getElementById('loading-overlay').style.display = 'none';
                },
                error: (err) => {
                    alert("Error accessing the source sheet. Please ensure it is published as CSV.");
                }
            });
        }

        function populateCategories() {
            const select = document.getElementById('category-list');
            const categories = [...new Set(fullDataset.map(item => item.Category))].filter(Boolean).sort();
            
            if (categories.length > 0) {
                select.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            } else {
                select.innerHTML = `<option value="">No categories found</option>`;
            }
        }

        function handleLogin() {
            currentUser = document.getElementById('user-name').value;
            currentCategory = document.getElementById('category-list').value;

            if (!currentCategory) {
                alert("Please select a category");
                return;
            }

            document.getElementById('header-user').innerText = `User: ${currentUser}`;
            document.getElementById('header-cat').innerText = `Category: ${currentCategory}`;
            
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-page').classList.remove('hidden');

            renderGrids();
        }

        function renderGrids() {
            const filtered = fullDataset.filter(item => item.Category === currentCategory);
            
            const newData = filtered.filter(i => i.Model.toLowerCase().includes('new')).slice(0, 6);
            const prodData = filtered.filter(i => i.Model.toLowerCase().includes('prod')).slice(0, 6);

            const newGrid = document.getElementById('new-grid');
            const prodGrid = document.getElementById('prod-grid');

            newGrid.innerHTML = newData.map(item => createCard(item)).join('');
            prodGrid.innerHTML = prodData.map(item => createCard(item)).join('');

            if (newData.length === 0) newGrid.innerHTML = '<p class="text-gray-400 col-span-full py-10 text-center">No "New" models found</p>';
            if (prodData.length === 0) prodGrid.innerHTML = '<p class="text-gray-400 col-span-full py-10 text-center">No "Prod" models found</p>';

            document.querySelectorAll('.sku-check').forEach(box => {
                box.addEventListener('change', updateCount);
            });
        }

        function createCard(item) {
            const fallbackImg = "https://via.placeholder.com/300x300?text=Image+Not+Found";
            
            return `
                <div class="relative bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm image-container group">
                    <div class="aspect-square bg-white flex items-center justify-center p-2">
                        <img src="${item.url}" 
                             onerror="this.src='${fallbackImg}'" 
                             class="max-w-full max-h-full object-contain transition-transform duration-300 group-hover:scale-105"
                             alt="${item.Sku_id}">
                    </div>
                    <div class="p-3 border-t border-gray-50 bg-white">
                        <div class="flex justify-between items-start">
                            <span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded uppercase tracking-tight">${item.Sku_id}</span>
                        </div>
                        <p class="text-[11px] font-semibold text-gray-700 mt-1 truncate" title="${item['File name']}">${item['File name']}</p>
                        <p class="text-[10px] text-gray-400 italic">${item.Model}</p>
                    </div>
                    <input type="checkbox" class="checkbox-overlay sku-check" 
                           data-sku="${item.Sku_id}" 
                           data-model="${item.Model}"
                           data-file="${item['File name']}">
                </div>
            `;
        }

        function updateCount() {
            const count = document.querySelectorAll('.sku-check:checked').length;
            document.getElementById('selection-count').innerText = `${count} Items Selected`;
        }

        function submitToForm() {
            const selected = Array.from(document.querySelectorAll('.sku-check:checked'));
            
            if (selected.length === 0) {
                alert("Please select at least one item.");
                return;
            }

            const item = selected[0].dataset;
            
            const prefillUrl = `${FORM_BASE}` +
                `&entry.106248745=${encodeURIComponent(currentUser)}` +
                `&entry.675861556=${encodeURIComponent(item.sku)}` +
                `&entry.1292743855=${encodeURIComponent(item.model)}` +
                `&entry.341097138=${encodeURIComponent(currentCategory)}` +
                `&entry.94706720=${encodeURIComponent(item.file)}`;

            window.open(prefillUrl, '_blank');
        }
    </script>
</body>
</html>
