<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QC Review Dashboard</title>
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/logo/unnamed.png" type="image/x-icon" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f7fa;
      color: #333;
    }
    header {
      background: #0057a3;
      color: white;
      padding: 0;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    header h1 {
      margin: 10px 0;
      font-size: 1.8em;
    }
    .container {
      display: none;
      flex-direction: column; /* Changed to column for better mobile layout */
      justify-content: center;
      align-items: center;
      padding: 1rem;
      gap: 1rem;
    }
    .image-box {
      flex: 1;
      text-align: center;
      width: 100%;
    }
    .image-box img {
      width: 100%;
      height: auto;
      max-height: 600px;
      object-fit: contain;
      margin-bottom: 5px;
      border-radius: 8px; /* Added rounded corners */
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .meta {
      font-size: 0.95em;
      color: #666;
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .controls {
      display: none;
      margin: 30px auto;
      text-align: center;
      padding: 0 1rem;
    }
    .status-group {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .status-group label {
      font-size: 1rem;
      background: #e9f0f7;
      padding: 10px 15px;
      border-radius: 20px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: background 0.3s, border-color 0.3s;
    }
    .status-group input[type="radio"] {
      display: none;
    }
    .status-group input[type="radio"]:checked + label {
      background: #0073e6;
      color: white;
      border-color: #0057a3;
    }
    button {
      padding: 12px 25px;
      font-size: 1rem;
      background-color: #0073e6;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
    }
    button:hover {
      background-color: #0057a3;
      transform: translateY(-2px);
    }
    .progress {
      text-align: center;
      margin-top: 15px;
      font-size: 1.1rem;
      color: #444;
    }
    iframe {
      display: none;
    }
    #loginScreen {
      text-align: center;
      margin-top: 50px;
    }
    #loginScreen select,
    #loginScreen button {
      padding: 12px;
      font-size: 1em;
      border-radius: 8px;
    }
    .date-range-filter {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 15px 0;
    }
    .date-range-filter select {
        flex: 1;
        max-width: 200px;
    }
    @media (min-width: 768px) {
      .container {
        flex-direction: row;
        gap: 20px;
      }
      .controls {
        width: 80%;
        max-width: 800px;
      }
    }
  </style>
</head>
<body onload="loadInitialData()">

<header>
  <h1>Image QC Review Dashboard</h1>
</header>

<p id="progressText" class="progress"></p>

<div id="loginScreen">
  <h2>Login to Start QC Review</h2>
  <select id="emailInput">
    <option value="" disabled selected>Select your email ID</option>
    <option value="samir.ansari@spyne.co.in">samir.ansari@spyne.co.in</option>
    <option value="ajay.prajapati@spyne.co.in">ajay.prajapati@spyne.co.in</option>
    <option value="sneha.swami@spyne.co.in">sneha.swami@spyne.co.in</option>
    <option value="rahul.kumar1@spyne.co.in">rahul.kumar1@spyne.co.in</option>
    <option value="dinesh.mishra@spyne.co.in">dinesh.mishra@spyne.co.in</option>
    <option value="chhotu.singh@spyne.co.in">chhotu.singh@spyne.co.in</option>
    <option value="bashishth.singh@spyne.co.in">bashishth.singh@spyne.co.in</option>
    <option value="kartik.kumar@spyne.co.in">kartik.kumar@spyne.co.in</option>
    <option value="dharmendra.kumar@spyne.co.in">dharmendra.kumar@spyne.co.in</option>
    <option value="rambha.prajapati@spyne.co.in">rambha.prajapati@spyne.co.in</option>
    <option value="raushan.kumar1@spyne.co.in">raushan.kumar1@spyne.co.in</option>
    <option value="pradeep.singh@spyne.co.in">pradeep.singh@spyne.co.in</option>
    <option value="kavi.singh@spyne.co.in">kavi.singh@spyne.co.in</option>
    <option value="vikas.gupta@spyne.co.in">vikas.gupta@spyne.co.in</option>
    <option value="rahul.ranjan@spyne.co.in">rahul.ranjan@spyne.co.in</option>
    <option value="ankesh.raj@spyne.co.in">ankesh.raj@spyne.co.in</option>
    <option value="mukesh.kholi@spyne.co.in">mukesh.kholi@spyne.co.in</option>
    <option value="manoj.punn@spyne.co.in">manoj.punn@spyne.co.in</option>
    <option value="bharat.bhushan@spyne.co.in">bharat.bhushan@spyne.co.in</option>
    <option value="ajit.yadav@spyne.co.in">ajit.yadav@spyne.co.in</option>
  </select>
  <br><br>
  <div class="date-range-filter">
      <select id="startDate">
        <option value="" disabled selected>Start Date</option>
      </select>
      <select id="endDate">
        <option value="" disabled selected>End Date</option>
      </select>
  </div>
  <br>
  <button onclick="login()">Start Review</button>
</div>

<div class="container" id="imageContainer">
  <div class="image-box">
    <h3>Input Image</h3>
    <img id="inputImg" loading="lazy" alt="Input Image">
    <div class="meta">
      <span>Image ID: <span id="imgId">-</span></span>
      <span>SKU Name: <span id="skuName">-</span></span>
    </div>
  </div>
  <div class="image-box">
    <h3>Output Image</h3>
    <img id="outputImg" loading="lazy" alt="Output Image">
    <div class="meta">
      <span>SKU ID: <span id="skuId">-</span></span>
    </div>
  </div>
</div>

<div class="controls" id="controlPanel">
  <div class="status-group">
    <input type="radio" id="bgRemoval" name="status" value="BG Removal">
    <label for="bgRemoval">1 - BG Removal</label>
    <input type="radio" id="bgIssue" name="status" value="BG Issue">
    <label for="bgIssue">2 - BG Issue</label>
    <input type="radio" id="seeThrough" name="status" value="See through">
    <label for="seeThrough">3 - See through</label>
    <input type="radio" id="shadow" name="status" value="Shadow">
    <label for="shadow">4 - Shadow</label>
    <input type="radio" id="logo" name="status" value="Logo">
    <label for="logo">5 - Logo</label>
  </div>
  <button onclick="submitForm()">Next</button>
</div>

<iframe id="hiddenSubmitFrame" name="hiddenSubmitFrame"></iframe>

<script>
  // Added a cache-busting parameter to the URL to ensure the latest data is always fetched.
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSEu3pra-CWUqYE-PZr2ipjZlc8HnI2fjY9DHoFiyg9EyXTxTVtW-F6kEzvkDHao70oQIs_q18pc_WW/pub?gid=0&single=true&output=csv&cacheBust=" + new Date().getTime();
  let allData = [];
  let data = [];
  let currentIndex = 0;
  let userEmail = "";

  function loadInitialData() {
    document.getElementById("progressText").innerText = "ðŸ“¦ Loading data...";
    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(results) {
        allData = results.data.filter(row => row.created_on); // Ensure 'created_on' exists
        populateDateFilters(allData);
        document.getElementById("progressText").innerText = "";
      }
    });
  }

  function populateDateFilters(data) {
    const dates = new Set();
    data.forEach(row => {
      dates.add(row.created_on);
    });

    const sortedDates = Array.from(dates).sort();

    const startDateSelect = document.getElementById("startDate");
    const endDateSelect = document.getElementById("endDate");

    // Clear existing options, but preserve the placeholder
    startDateSelect.options.length = 1;
    endDateSelect.options.length = 1;

    sortedDates.forEach(date => {
      const option1 = document.createElement("option");
      option1.value = date;
      option1.text = date;
      startDateSelect.appendChild(option1);

      const option2 = document.createElement("option");
      option2.value = date;
      option2.text = date;
      endDateSelect.appendChild(option2);
    });
  }

  function login() {
    const emailInput = document.getElementById("emailInput");
    userEmail = emailInput.value.trim();
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;

    if (!userEmail || !userEmail.includes("@")) {
      showCustomAlert("Please select a valid email ID.");
      return;
    }
    
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("progressText").innerText = "ðŸ“¦ Filtering data...";

    data = allData.filter(row => {
      const createdOnDate = new Date(row.created_on);
      const startDateTime = startDate ? new Date(startDate) : null;
      const endDateTime = endDate ? new Date(endDate) : null;

      if (startDateTime && endDateTime && startDateTime > endDateTime) {
          showCustomAlert("End date cannot be before start date.");
          document.getElementById("loginScreen").style.display = "block";
          document.getElementById("progressText").innerText = "";
          return false;
      }
      
      const isAfterStart = !startDateTime || createdOnDate >= startDateTime;
      const isBeforeEnd = !endDateTime || createdOnDate <= endDateTime;

      // Only show data where the 'status' column is null or an empty string
      const isStatusEmpty = !row.status || row.status.trim() === '';
      
      return isAfterStart && isBeforeEnd && isStatusEmpty;
    });
    
    currentIndex = 0;
    if (data.length === 0) {
      document.getElementById("progressText").innerText = "No unreviewed images found for the selected dates.";
    } else {
      document.getElementById("imageContainer").style.display = "flex";
      document.getElementById("controlPanel").style.display = "block";
      document.getElementById("progressText").innerText = "";
      showImage();
      preloadNextImages();
    }
  }

  function showImage() {
    if (currentIndex >= data.length) {
      document.getElementById("progressText").innerText = "All images in this set have been reviewed.";
      document.getElementById("imageContainer").style.display = "none";
      document.getElementById("controlPanel").style.display = "none";
      return;
    }

    const row = data[currentIndex];
    document.getElementById("inputImg").src = row["input_image_hres_url"];
    document.getElementById("outputImg").src = row["output_image_hres_url"];
    document.getElementById("imgId").innerText = row["image_id"];
    document.getElementById("skuId").innerText = row["sku_id"];
    document.getElementById("skuName").innerText = row["sku_name"];
    preloadNextImages();
  }

  function submitForm() {
    if (!userEmail || !userEmail.includes("@")) {
      showCustomAlert("Login required. Please refresh and log in.");
      return;
    }

    let status = document.querySelector('input[name="status"]:checked');
    // If no status is selected, default to "Done"
    if (!status) {
      status = { value: "Done" };
    }

    const row = data[currentIndex];
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = 'https://docs.google.com/forms/d/e/1FAIpQLSdlr7DrJdpzz93xd4unoEULukHMvkTNl0CZlt-Jephem-6r6A/formResponse';
    form.target = 'hiddenSubmitFrame';

    const fields = [
      { name: 'entry.331138758', value: row["image_id"] },
      { name: 'entry.921407097', value: row["sku_id"] },
      { name: 'entry.105594411', value: row["sku_name"] },
      { name: 'entry.2036611691', value: status.value },
      { name: 'entry.1651774948', value: userEmail }
    ];

    fields.forEach(({ name, value }) => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = name;
      input.value = value;
      form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);

    currentIndex++;
    showImage();
    document.querySelectorAll('input[name="status"]').forEach(el => el.checked = false);
  }

  function preloadNextImages() {
    for (let i = 1; i <= 3; i++) {
      if (currentIndex + i < data.length) {
        const nextRow = data[currentIndex + i];
        new Image().src = nextRow["input_image_hres_url"];
        new Image().src = nextRow["output_image_hres_url"];
      }
    }
  }

  function showCustomAlert(message) {
    const alertModal = document.createElement('div');
    alertModal.style.position = 'fixed';
    alertModal.style.top = '50%';
    alertModal.style.left = '50%';
    alertModal.style.transform = 'translate(-50%, -50%)';
    alertModal.style.backgroundColor = '#fff';
    alertModal.style.padding = '20px';
    alertModal.style.borderRadius = '8px';
    alertModal.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.2)';
    alertModal.style.zIndex = '1000';
    alertModal.style.textAlign = 'center';
    alertModal.innerHTML = `
      <p>${message}</p>
      <button onclick="this.parentNode.remove()" style="margin-top: 10px; padding: 8px 16px; border-radius: 6px; background-color: #0073e6; color: white; border: none; cursor: pointer;">OK</button>
    `;
    document.body.appendChild(alertModal);
  }

  document.addEventListener("keydown", function(event) {
    const key = event.key.toLowerCase();
    const code = event.code;

    if (key === "1" || code === "Numpad1") {
      document.getElementById('bgRemoval').checked = true;
    } else if (key === "2" || code === "Numpad2") {
      document.getElementById('bgIssue').checked = true;
    } else if (key === "3" || code === "Numpad3") {
      document.getElementById('seeThrough').checked = true;
    } else if (key === "4" || code === "Numpad4") {
      document.getElementById('shadow').checked = true;
    } else if (key === "5" || code === "Numpad5") {
      document.getElementById('logo').checked = true;
    } else if (key === "enter") {
      event.preventDefault();
      submitForm();
    }
  });
</script>

</body>
</html>
